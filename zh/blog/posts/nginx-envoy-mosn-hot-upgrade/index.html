<!doctype html>
<html lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.55.5" />

<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">



<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Nginx vs Envoy vs MOSN 平滑升级原理解析 | MOSN</title><meta property="og:title" content="Nginx vs Envoy vs MOSN 平滑升级原理解析" />
<meta property="og:description" content="本文是对 Nginx、Envoy 及 MOSN 的平滑升级原理区别的分析，适合对 Nginx 实现原理比较感兴趣的同学阅读，需要具备一定的网络编程知识。
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mosn.io/zh/blog/posts/nginx-envoy-mosn-hot-upgrade/" />
<meta property="article:published_time" content="2019-12-28T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2020-02-11T17:50:18&#43;08:00"/><meta property="og:site_name" content="MOSN" />

<meta itemprop="name" content="Nginx vs Envoy vs MOSN 平滑升级原理解析">
<meta itemprop="description" content="本文是对 Nginx、Envoy 及 MOSN 的平滑升级原理区别的分析，适合对 Nginx 实现原理比较感兴趣的同学阅读，需要具备一定的网络编程知识。
">


<meta itemprop="datePublished" content="2019-12-28T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2020-02-11T17:50:18&#43;08:00" />
<meta itemprop="wordCount" content="494">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Nginx vs Envoy vs MOSN 平滑升级原理解析"/>
<meta name="twitter:description" content="本文是对 Nginx、Envoy 及 MOSN 的平滑升级原理区别的分析，适合对 Nginx 实现原理比较感兴趣的同学阅读，需要具备一定的网络编程知识。
"/>





<link rel="preload" href="/scss/main.min.676129cd82c5d6313966e45f7f94305a81ed4a484134928ccef8dc26b82dbb53.css" as="style">
<link href="/scss/main.min.676129cd82c5d6313966e45f7f94305a81ed4a484134928ccef8dc26b82dbb53.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>




    <title>Nginx vs Envoy vs MOSN 平滑升级原理解析 | MOSN</title>
  </head>
  <body class="td-page td-blog">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/zh/">
		<span class="navbar-logo"></span><span class="text-uppercase font-weight-bold">MOSN</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/zh/about/" ><span>关于</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/zh/docs/" ><span>文档</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link active" href="/zh/blog/" ><span class="active">博客</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="/zh/community/" ><span>社区</span></a>
			</li>
			
			
			
			<li class="nav-item dropdown d-none d-lg-block">
				

<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	中文
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="/">English</a>
	
</div>
			</li>
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">
<input type="search" class="form-control td-search-input" placeholder="&#xf002 搜索本站" aria-label="搜索本站" autocomplete="off">
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            




<div id="td-sidebar-menu" class="td-sidebar__inner">
  
  <form class="td-sidebar__search d-flex align-items-center">
    
<input type="search" class="form-control td-search-input" placeholder="&#xf002 搜索本站" aria-label="搜索本站" autocomplete="off">

    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  
  <nav class="collapse td-sidebar-nav pt-2 pl-4" id="td-section-nav">
    
    <div class="nav-item dropdown d-block d-lg-none">
      

<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	中文
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="/">English</a>
	
</div>
    </div>
    
    






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/zh/blog/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">博客</a>
  </li>
  <ul>
    <li class="collapse show" id="zh-blog">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/zh/blog/releases/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">发布</a>
  </li>
  <ul>
    <li class="collapse " id="zh-blog-releases">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-zh-blog-releases-v0-10-0" href="/zh/blog/releases/v0.10.0/">MOSN v0.10.0 变更日志</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-zh-blog-releases-mosn-0-1-0-perfermence-report" href="/zh/blog/releases/mosn-0.1.0-perfermence-report/">MOSN 0.1.0 性能报告</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-zh-blog-releases-mosn-0-2-1-performance-report" href="/zh/blog/releases/mosn-0.2.1-performance-report/">MOSN 0.2.1 性能报告</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/zh/blog/news/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">新闻</a>
  </li>
  <ul>
    <li class="collapse " id="zh-blog-news">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-zh-blog-news-announcing-mosn-communtiy" href="/zh/blog/news/announcing-mosn-communtiy/">MOSN 社区成立</a>
      
      
    </li>
  </ul>
</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">
  <li class="td-sidebar-nav__section-title">
    <a  href="/zh/blog/posts/" class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">分享</a>
  </li>
  <ul>
    <li class="collapse show" id="zh-blog-posts">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-zh-blog-posts-mosn-variable" href="/zh/blog/posts/mosn-variable/">MOSN 源码解析 - 变量机制</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-zh-blog-posts-mosn-buffer" href="/zh/blog/posts/mosn-buffer/">MOSN 源码分析 - 内存复用机制</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-zh-blog-posts-mosn-plugin" href="/zh/blog/posts/mosn-plugin/">MOSN 源码解析 - plugin 机制</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-zh-blog-posts-mosn-xds" href="/zh/blog/posts/mosn-xds/">MOSN 源码分析 - XDS</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-zh-blog-posts-mosn-filters" href="/zh/blog/posts/mosn-filters/">MOSN 源码解析 - filter扩展机制</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page  active" id="m-zh-blog-posts-nginx-envoy-mosn-hot-upgrade" href="/zh/blog/posts/nginx-envoy-mosn-hot-upgrade/">Nginx vs Envoy vs MOSN 平滑升级原理解析</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-zh-blog-posts-mosn-reconfig-mechanism" href="/zh/blog/posts/mosn-reconfig-mechanism/">mosn 的reconfig 机制</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-zh-blog-posts-mosn-source-code-brief" href="/zh/blog/posts/mosn-source-code-brief/">MOSN 源码浅析</a>
      
      
    </li>
  </ul>
</ul>

      
      
    </li>
  </ul>
</ul>

  </nav>
</div>




          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
            




<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">





<a href="https://github.com/mosn/mosn.io/edit/master/content/zh/blog/posts/nginx-envoy-mosn-hot-upgrade/index.md" target="_blank"><i class="fa fa-edit fa-fw"></i> 编辑本页</a>
<a href="https://github.com/mosn/mosn.io/issues/new?title=Nginx%20vs%20Envoy%20vs%20MOSN%20%e5%b9%b3%e6%bb%91%e5%8d%87%e7%ba%a7%e5%8e%9f%e7%90%86%e8%a7%a3%e6%9e%90" target="_blank"><i class="fab fa-github fa-fw"></i> 创建文档 issue</a>


<a href="https://github.com/mosn/mosn/issues/new" target="_blank"><i class="fas fa-tasks fa-fw"></i> 创建项目 issue</a>

</div>






<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#前言">前言</a></li>
<li><a href="#nginx">Nginx</a></li>
<li><a href="#envoy">Envoy</a></li>
<li><a href="#mosn">MOSN</a></li>
<li><a href="#对比">对比</a></li>
</ul></li>
</ul>
</nav>



          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role="main">
            <a class="btn btn-lg -bg-orange td-rss-button d-none d-lg-block" href="https://mosn.io/zh/blog/posts/index.xml" target="_blank">
              RSS <i class="fa fa-rss ml-2 "></i>
            </a>
            
<div class="td-content">
	<h1>Nginx vs Envoy vs MOSN 平滑升级原理解析</h1>
	<div class="lead">本文是对 Nginx、Envoy 及 MOSN 的平滑升级原理区别的分析，适合对 Nginx 实现原理比较感兴趣的同学阅读，需要具备一定的网络编程知识。</div>
	<div class="td-byline mb-4">
		作者 <b><a href="https://ms2008.github.io" target="_blank">@ms2008</a></b> |
		<time datetime="2019-12-28" class="text-muted">2019年12月28日</time>
	</div>
	

<h2 id="前言">前言</h2>

<p>本文是对 Nginx、Envoy 及 MOSN 的平滑升级原理区别的分析，适合对 Nginx 实现原理比较感兴趣的同学阅读，需要具备一定的网络编程知识。</p>

<p><strong>平滑升级的本质就是 listener fd 的迁移</strong>，虽然 Nginx、Envoy、MOSN 都提供了平滑升级支持，但是鉴于它们进程模型的差异，反映在实现上还是有些区别的。这里来探讨下它们其中的区别，并着重介绍 Nginx 的实现。</p>

<h2 id="nginx">Nginx</h2>

<p>相信有很多人认为 Nginx 的 reload 操作就能完成平滑升级，其实这是个典型的理解错误。实际上 reload 操作仅仅是平滑重启，并没有真正的升级新的二进制文件，也就是说其运行的依然是老的二进制文件。</p>

<p>Nginx 自身也并没有提供平滑升级的命令选项，其只能靠手动触发信号来完成。具体正确的操作步骤可以参考这里：<a href="http://nginx.org/en/docs/control.html#upgrade" target="_blank">Upgrading Executable on the Fly</a>，这里只分析下其实现原理。</p>

<p><strong>Nginx 的平滑升级是通过 <code>fork</code> + <code>execve</code> 这种经典的处理方式来实现的</strong>。准备升级时，Old Master 进程收到信号然后 <code>fork</code> 出一个子进程，注意此时这个子进程运行的依然是老的镜像文件。紧接着这个子进程会通过 <code>execve</code> 调用执行新的二进制文件来替换掉自己，成为 New Master。</p>

<p>那么问题来了：New Master 启动时按理说会执行 <code>bind</code> + <code>listen</code> 等操作来初始化监听，而这时候 Old Master 还没有退出，端口未释放，执行 <code>execve</code> 时理论上应该会报：<code>Address already in use</code> 错误，但是实际上这里却没有任何问题，这是为什么？</p>

<p>因为 Nginx 在 <code>execve</code> 的时候压根就没有重新 <code>bind</code> + <code>listen</code>，而是直接把 listener fd 添加到 <code>epoll</code> 的事件表。因为这个 New Master 本来就是从 Old Master 继承而来，自然就继承了 Old Master 的 listener fd，但是这里依然有一个问题：该怎么通知 New Master 呢？</p>

<p><strong>环境变量</strong>。<code>execve</code> 在执行的时候可以传入环境变量。实际上 Old Master 在 <code>fork</code> 之前会将所有 listener fd 添加到 <code>NGINX</code> 环境变量：</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="color:#204a87;font-weight:bold">ngx_pid_t</span>
<span style="color:#4e9a06">ngx_exec_new_binary(ngx_cycle_t</span> <span style="color:#4e9a06">*cycle,</span> <span style="color:#4e9a06">char</span> <span style="color:#4e9a06">*const</span> <span style="color:#4e9a06">*argv)</span>
<span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">...</span>
    <span style="color:#4e9a06">ctx.path</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">argv[0]</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">ctx.name</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;new</span> <span style="color:#4e9a06">binary</span> <span style="color:#4e9a06">process&#34;</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">ctx.argv</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">argv</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">n</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">env</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">ngx_set_environment(cycle,</span> <span style="color:#4e9a06">&amp;n)</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">...</span>
    <span style="color:#4e9a06">env[n++]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">var</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">env[n]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">NULL</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">...</span>
    <span style="color:#4e9a06">ctx.envp</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">(char</span> <span style="color:#4e9a06">*const</span> <span style="color:#4e9a06">*)</span> <span style="color:#4e9a06">env</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">ccf</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">(ngx_core_conf_t</span> <span style="color:#4e9a06">*)</span> <span style="color:#4e9a06">ngx_get_conf(cycle-&gt;conf_ctx,</span> <span style="color:#4e9a06">ngx_core_module)</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#4e9a06">(ngx_rename_file(ccf-&gt;pid.data,</span> <span style="color:#4e9a06">ccf-&gt;oldpid.data)</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#4e9a06">NGX_FILE_ERROR)</span> <span style="color:#000;font-weight:bold">{</span>
       <span style="color:#204a87;font-weight:bold">...</span>
        <span style="color:#4e9a06">return</span> <span style="color:#4e9a06">NGX_INVALID_PID</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#204a87;font-weight:bold">pid</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">ngx_execute(cycle,</span> <span style="color:#4e9a06">&amp;ctx)</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">pid</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span></code></pre></div>
<p>Nginx 在启动的时候，会解析 <code>NGINX</code> 环境变量：</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#4e9a06">ngx_int_t</span>
<span style="color:#4e9a06">ngx_add_inherited_sockets(ngx_cycle_t</span> <span style="color:#4e9a06">*cycle)</span>
<span style="color:#000;font-weight:bold">{</span>
<span style="color:#204a87;font-weight:bold">...</span>
    <span style="color:#4e9a06">inherited</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">(u_char</span> <span style="color:#4e9a06">*)</span> <span style="color:#4e9a06">getenv(NGINX_VAR)</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#4e9a06">(inherited</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#4e9a06">NULL)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">NGX_OK</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#4e9a06">(ngx_array_init(&amp;cycle-&gt;listening,</span> <span style="color:#4e9a06">cycle-&gt;pool,</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#4e9a06">,</span>
                       <span style="color:#4e9a06">sizeof(ngx_listening_t))</span>
        <span style="color:#4e9a06">!=</span> <span style="color:#4e9a06">NGX_OK)</span>
    <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">NGX_ERROR</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#4e9a06">(p</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">inherited,</span> <span style="color:#4e9a06">v</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">p</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">*p</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">p++)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#4e9a06">(*p</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#4e9a06">&#39;:&#39;</span> <span style="color:#4e9a06">||</span> <span style="color:#4e9a06">*p</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#4e9a06">&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#204a87;font-weight:bold">&#39;)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">s</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">ngx_atoi(v,</span> <span style="color:#4e9a06">p</span> <span style="color:#4e9a06">-</span> <span style="color:#4e9a06">v)</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#204a87;font-weight:bold">...</span>
            <span style="color:#4e9a06">v</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">p</span> <span style="color:#4e9a06">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>

            <span style="color:#204a87;font-weight:bold">ls</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">ngx_array_push(&amp;cycle-&gt;listening)</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#4e9a06">(ls</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#4e9a06">NULL)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">NGX_ERROR</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">}</span>

            <span style="color:#204a87;font-weight:bold">ngx_memzero(ls,</span> <span style="color:#4e9a06">sizeof(ngx_listening_t))</span><span style="color:#000;font-weight:bold">;</span>

            <span style="color:#204a87;font-weight:bold">ls-&gt;fd</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">(ngx_socket_t)</span> <span style="color:#4e9a06">s</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#204a87;font-weight:bold">...</span>
    <span style="color:#4e9a06">ngx_inherited</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">ngx_set_inherited_sockets(cycle)</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span></code></pre></div>
<p>一旦检测到是继承而来的 socket，那就说明已经打开了，不会再继续 <code>bind</code> + <code>listen</code> 了：</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="color:#204a87;font-weight:bold">ngx_int_t</span>
<span style="color:#4e9a06">ngx_open_listening_sockets(ngx_cycle_t</span> <span style="color:#4e9a06">*cycle)</span>
<span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">...</span>
    <span style="color:#4e9a06">/*</span> <span style="color:#4e9a06">TODO:</span> <span style="color:#4e9a06">configurable</span> <span style="color:#4e9a06">try</span> <span style="color:#4e9a06">number</span> <span style="color:#4e9a06">*/</span>

    <span style="color:#4e9a06">for</span> <span style="color:#4e9a06">(tries</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">tries</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">tries--)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">failed</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>

        <span style="color:#204a87;font-weight:bold">/*</span> <span style="color:#4e9a06">for</span> <span style="color:#4e9a06">each</span> <span style="color:#4e9a06">listening</span> <span style="color:#4e9a06">socket</span> <span style="color:#4e9a06">*/</span>

        <span style="color:#4e9a06">ls</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">cycle-&gt;listening.elts</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#4e9a06">(i</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">i</span> <span style="color:#4e9a06">&lt;</span> <span style="color:#4e9a06">cycle-&gt;listening.nelts</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">i++)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">...</span>
            <span style="color:#4e9a06">if</span> <span style="color:#4e9a06">(ls[i].inherited)</span> <span style="color:#000;font-weight:bold">{</span>

                <span style="color:#204a87;font-weight:bold">/*</span> <span style="color:#4e9a06">TODO:</span> <span style="color:#4e9a06">close</span> <span style="color:#000">on</span> <span style="color:#4e9a06">exit</span> <span style="color:#4e9a06">*/</span>
                <span style="color:#4e9a06">/*</span> <span style="color:#4e9a06">TODO:</span> <span style="color:#4e9a06">nonblocking</span> <span style="color:#4e9a06">*/</span>
                <span style="color:#4e9a06">/*</span> <span style="color:#4e9a06">TODO:</span> <span style="color:#4e9a06">deferred</span> <span style="color:#4e9a06">accept</span> <span style="color:#4e9a06">*/</span>

                <span style="color:#4e9a06">continue</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#204a87;font-weight:bold">...</span>

            <span style="color:#4e9a06">ngx_log_debug2(NGX_LOG_DEBUG_CORE,</span> <span style="color:#4e9a06">log,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#4e9a06">,</span>
                           <span style="color:#4e9a06">&#34;bind()</span> <span style="color:#4e9a06">%V</span> <span style="color:#8f5902;font-style:italic">#%d &#34;, &amp;ls[i].addr_text, s);
</span><span style="color:#8f5902;font-style:italic"></span>
            <span style="color:#4e9a06">if</span> <span style="color:#4e9a06">(bind(s,</span> <span style="color:#4e9a06">ls[i].sockaddr,</span> <span style="color:#4e9a06">ls[i].socklen)</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#4e9a06">-1)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#204a87;font-weight:bold">...</span>
            <span style="color:#a40000">}</span>
            <span style="color:#4e9a06">...</span>
        <span style="color:#a40000">}</span>
    <span style="color:#a40000">}</span>

    <span style="color:#4e9a06">if</span> <span style="color:#4e9a06">(failed)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">ngx_log_error(NGX_LOG_EMERG,</span> <span style="color:#4e9a06">log,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#4e9a06">,</span> <span style="color:#4e9a06">&#34;still</span> <span style="color:#4e9a06">could</span> <span style="color:#4e9a06">not</span> <span style="color:#4e9a06">bind()&#34;)</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">NGX_ERROR</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">NGX_OK</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span></code></pre></div>
<h2 id="envoy">Envoy</h2>

<p>Envoy 使用的是单进程多线程模型，其局限就是无法通过环境变量来传递 listener fd。因此 Envoy 采用的是 UDS（unix domain sockets）方案。当 New Envoy 启动完成后，会通过 UDS 向 Old Envoy 请求 listener fd 副本，拿到 listener fd 之后开始接管新来的连接，并通知 Old Envoy 终止运行。</p>

<blockquote>
<p>file descriptor 是可以通过 <code>sendmsg/recvmsg</code> 来传递的。</p>
</blockquote>

<h2 id="mosn">MOSN</h2>

<p>MOSN 的方案和 Envoy 类似，都是通过 UDS 来传递 listener fd。但是其比 Envoy 更厉害的地方在于它可以把老的连接从 Old MOSN 上迁移到 New MOSN 上。<strong>也就是说把一个连接从进程 A 迁移到进程 B，而保持连接不断</strong>！！！厉不厉害？听起来很简单，但是实现起来却没那么容易，比如数据已经被拷贝到了应用层，但是还没有被处理，怎么办？这里面有很多细节需要处理。它子所以能做到这种层面，靠的也是内核的 <code>sendmsg/recvmsg</code> 技术。</p>

<blockquote>
<p>SCM_RIGHTS - Send or receive a set of open file descriptors from another process. The data portion contains an integer array of the file descriptors. The passed file descriptors behave as though they have been created with dup(2). <a href="http://linux.die.net/man/7/unix" target="_blank">http://linux.die.net/man/7/unix</a></p>
</blockquote>

<p>这里有一个 Go 实现的小 Demo: <a href="https://zhuanlan.zhihu.com/p/97340154" target="_blank">tcp链接迁移</a>。</p>

<h2 id="对比">对比</h2>

<p>Nginx 的实现是兼容性最强的，因为 Envoy 和 MOSN 都依赖 <code>sendmsg/recvmsg</code> 系统调用，需要内核 3.5+ 支持。MOSN 的难度最高，算得上是真正的无损升级，而 Nginx 和 Envoy 对于老的连接，仅仅是实现 graceful shutdown，严格来说是有损的。这对于 HTTP(通过 <code>Connection: close</code>) 和 gRPC(GoAway Frame) 协议支持很友好，但是遇到自定义的 TCP 协议就抓瞎了。如果遇到客户端没有处理 <code>close</code> 异常，很容易发生 socket fd 泄露问题。</p>

<p>本文作者 ms2008，转载自<a href="https://ms2008.github.io/2019/12/28/hot-upgrade/" target="_blank">Nginx vs Envoy vs Mosn 平滑升级原理解析</a>。</p>

	

	<ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5">
  <li>
    <a href="/zh/blog/posts/mosn-reconfig-mechanism/" class="btn btn-primary "><span class="mr-1">←</span> 上一页</a>
  </li>
    <a href="/zh/blog/posts/mosn-filters/" class="btn btn-primary ">下一页 <span class="ml-1">→</span></a>
  </li>
</ul>

</div>


          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" href="https://twitter.com/MosnProxy">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" href="https://github.com/mosn/mosn">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2020 The MOSN Authors 保留所有权利</small>
        
	
      </div>
    </div>
  </div>
</footer>


    </div>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>






<script src="/js/main.min.4e95c929fcc5d1ae1c122429c4cddb74176be1e58cc1e30d5b89fc8914cd322a.js" integrity="sha256-TpXJKfzF0a4cEiQpxM3bdBdr4eWMweMNW4n8iRTNMio=" crossorigin="anonymous"></script>





  </body>
</html>